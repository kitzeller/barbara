<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>

<style>
    canvas{
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
</style>
<body>
<script src="https://code.jquery.com/jquery-3.4.1.js"></script>
<script src="http://threejs.org/build/three.min.js"></script>

<div style="position: absolute; top: 0; left: 0; color: white; z-index: 20; font-family: monospace">3D Quilt Prototype</div>
<div id="svgContainer" style="width: 0px; height: 0px;">
</div>

<script>
    if (window.location.search) {
        let res = parseQuery(window.location.search);
        console.log(res.id);

        $.getJSON("sessions/" + res.id, function (data) {
            console.log(data);
            // let svg = data.svg;

            $('#svgContainer').append('<svg width="800" height="800" viewBox="0 0 800 800">' + data.svg + '</svg>')
            runThree();

        });
    }

    /**
     * Parses the url query
     */
    function parseQuery(queryString) {
        var query = {};
        var pairs = (queryString[0] === '?' ? queryString.substr(1) : queryString).split('&');
        for (var i = 0; i < pairs.length; i++) {
            var pair = pairs[i].split('=');
            query[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '');
        }
        return query;
    }

    function runThree(){
        var mesh;
        var scene = new THREE.Scene();

        var camera = new THREE.PerspectiveCamera(50, 1200 / 800, 0.1, 1000);
        camera.position.z = 10;

        var renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        var svg = document.getElementById("svgContainer").querySelector("svg");
        var svgData = (new XMLSerializer()).serializeToString(svg);

        var canvas = document.createElement("canvas");
        var svgSize = svg.getBoundingClientRect();
        canvas.width = svgSize.width;
        canvas.height = svgSize.height;
        var ctx = canvas.getContext("2d");

        var img = document.createElement("img");
        img.setAttribute("src", "data:image/svg+xml;base64," + window.btoa(unescape(encodeURIComponent(svgData))) );

        img.onload = function() {
            ctx.drawImage(img, 0, 0);

            var texture = new THREE.Texture(canvas);
            texture.needsUpdate = true;

            var geometry = new THREE.PlaneGeometry( 5, 5, 32 );
            var material = new THREE.MeshBasicMaterial({ map: texture, side: THREE.DoubleSide});
            material.map.minFilter = THREE.LinearFilter;
            mesh = new THREE.Mesh( geometry, material );
            scene.add(mesh);
        };

        var render = function () {
            requestAnimationFrame(render);
            mesh.rotation.y += 0.01;
            renderer.render(scene, camera);
        };

        render();
    }
</script>
</body>
</html>
